// ===== ПРОСТОЙ DROPDOWN ПОИСК В HEADER =====

const DropdownSearch = {
  // Элементы DOM
  elements: {
    input: null,
    button: null,
    dropdown: null
  },  // Данные для поиска
  searchData: [
    // === ПУТЬ АБИТУРИЕНТА ===
    {
      title: "Подача документов (июнь-июль)",
      url: "./pages/applicant-path/documents/",
      description: "Полный перечень документов для поступления в РГАУ-МСХА",
      category: "applicant",
      keywords: ["документы", "паспорт", "аттестат", "заявление", "фотографии", "медсправка", "поступление", "абитуриент", "приёмная комиссия", "справки", "оригиналы", "копии", "подача", "сдача документов", "требования", "список документов", "документооборот", "регистрация", "подачка"],
      tags: ["june", "july", "поступление", "документооборот", "абитуриент", "приёмная"]
    },
    {
      title: "Конкурсный отбор (конец июля)",
      url: "./pages/applicant-path/competitive-selection/",
      description: "Процедура конкурсного отбора и работа с приоритетами поступления",
      category: "applicant",
      keywords: ["конкурс", "отбор", "списки", "приоритеты", "баллы", "ЕГЭ", "рейтинг", "зачисление", "конкурсная процедура", "проходной балл", "конкурсные списки", "ранжирование", "согласие на зачисление", "приоритет", "конкурсная ситуация", "отборочные списки"],
      tags: ["july", "конкурс", "отбор", "рейтинг", "баллы"]
    },
    {
      title: "Зачисление (август)",
      url: "./pages/applicant-path/enrollment/",
      description: "Получение результатов зачисления и оформление документов студента",
      category: "applicant",
      keywords: ["зачисление", "приказ", "студенческий билет", "договор", "поступление", "результаты", "оформление", "поступил", "зачислен", "студент", "первокурсник", "приказ о зачислении", "оформление документов", "студбилет", "зачислили", "зачислился"],
      tags: ["august", "зачисление", "документы", "студент", "оформление"]
    },
    {
      title: "Заселение в общежитие (конец августа)",
      url: "./pages/applicant-path/dormitory-settlement/",
      description: "Процедура заселения в общежитие для новых студентов и первокурсников",
      category: "applicant",
      keywords: ["заселение", "общага", "общежитие", "комната", "проживание", "новички", "студенты", "первокурсники", "новый студент", "заселиться", "место в общежитии", "очередь на заселение", "комендант", "общежития", "дормитория", "хостел", "жильё", "поселиться"],
      tags: ["august", "общежитие", "заселение", "первокурсники", "жильё"]
    },
    {
      title: "Адаптация в университете (сентябрь)",
      url: "./pages/applicant-path/adaptation/",
      description: "Знакомство с университетом и студенческой жизнью для новичков",
      category: "applicant",
      keywords: ["адаптация", "первокурсники", "знакомство", "ориентация", "новички", "студенческая жизнь", "введение", "первые дни", "ознакомление", "новый студент", "адаптационная неделя", "введение в университет", "первый курс", "знакомство с университетом", "ориентировка"],
      tags: ["september", "адаптация", "первокурсники", "ориентация", "новички"]
    },

    // === ЖИЗНЬ В УНИВЕРСИТЕТЕ ===
    {
      title: "Общежитие и проживание",
      url: "./pages/university-life/dormitory/",
      description: "Подробная информация о заселении в общежитие и условиях проживания",
      category: "university-life",
      keywords: ["общежитие", "общага", "проживание", "комната", "соседи", "коммуналка", "быт", "жильё", "условия", "дом", "дормитория", "блок", "кухня", "душ", "прачечная", "правила проживания", "бытовые условия", "коммунальные услуги", "квартплата", "комендант", "вахта"],
      tags: ["жильё", "быт", "проживание", "общежитие", "условия"]
    },
    {
      title: "Инфраструктура университета",
      url: "./pages/university-life/infrastructure/",
      description: "Кампус университета и доступная инфраструктура для студентов",
      category: "university-life",
      keywords: ["кампус", "корпуса", "аудитории", "библиотека", "столовая", "спортзал", "инфраструктура", "здания", "помещения", "территория", "лаборатории", "компьютерные классы", "актовый зал", "медпункт", "буфет", "кафе", "спортивные залы", "стадион", "парковка"],
      tags: ["кампус", "здания", "инфраструктура", "территория", "удобства"]
    },
    {
      title: "Учебный процесс",
      url: "./pages/university-life/academic-process/",
      description: "Организация учебного процесса и академической деятельности в университете",
      category: "university-life",
      keywords: ["учёба", "занятия", "лекции", "семинары", "экзамены", "сессия", "расписание", "преподаватели", "обучение", "пары", "практические", "лабораторные", "курсовые", "дипломная", "зачёты", "академическая деятельность", "учебная программа", "модули", "кредиты", "оценки"],
      tags: ["учёба", "академия", "обучение", "занятия", "экзамены"]
    },

    // === СТИПЕНДИИ И ЛЬГОТЫ ===
    {
      title: "Стандартная стипендия",
      url: "./pages/scholarships/standard/",
      description: "Размеры и условия получения базовой академической и социальной стипендии",
      category: "scholarships",
      keywords: ["стипендия", "выплаты", "деньги", "финансы", "социальная", "академическая", "базовая", "стандартная", "обычная стипендия", "размер стипендии", "стипуха", "денежные выплаты", "финансовая поддержка", "бюджет", "деньги на жизнь"],
      tags: ["финансы", "выплаты", "стипендия", "деньги", "поддержка"]
    },
    {
      title: "Повышенная стипендия",
      url: "./pages/scholarships/enhanced/",
      description: "Система баллов и критерии для получения повышенной стипендии",
      category: "scholarships",
      keywords: ["повышенная стипендия", "баллы", "достижения", "активность", "премия", "дополнительная", "система баллов", "большая стипендия", "увеличенная стипендия", "больше денег", "доплата", "надбавка", "поощрительная стипендия", "мотивационная стипендия"],
      tags: ["финансы", "достижения", "баллы", "активность", "премия"]
    },
    {
      title: "Карта москвича (льготы)",
      url: "./pages/scholarships/moscow-card/",
      description: "Льготы и скидки по карте москвича для студентов столицы",
      category: "scholarships",
      keywords: ["карта москвича", "льготы", "скидки", "транспорт", "метро", "автобус", "студенческая карта", "проезд", "социальная карта", "московская карта", "льготный проезд", "скидки в магазинах", "бесплатный проезд", "общественный транспорт", "МЦК", "МЦД"],
      tags: ["льготы", "транспорт", "скидки", "карта", "Москва"]
    },
    {
      title: "Прочие льготы и поддержка",
      url: "./pages/scholarships/other-benefits/",
      description: "Дополнительные виды поддержки и льгот для студентов",
      category: "scholarships",
      keywords: ["льготы", "поддержка", "помощь", "материальная помощь", "социальная поддержка", "дополнительные льготы", "финансовая помощь", "единовременная выплата", "компенсации", "субсидии", "гранты", "социальные выплаты"],
      tags: ["поддержка", "льготы", "помощь", "выплаты", "социальная"]
    },

    // === ВОЕННАЯ ПОДГОТОВКА ===
    {
      title: "ВУЦ (военная кафедра)",
      url: "./pages/military/vuc/",
      description: "Военная подготовка в университете и военно-учебный центр",
      category: "military",
      keywords: ["ВУЦ", "военная кафедра", "военная подготовка", "армия", "офицер", "военком", "подготовка офицеров", "военно-учебный центр", "военное дело", "военные сборы", "воинское звание", "лейтенант", "военная служба", "офицерское звание"],
      tags: ["армия", "подготовка", "офицеры", "военная", "ВУЦ"]
    },
    {
      title: "Отсрочка от армии",
      url: "./pages/military/deferment/",
      description: "Как получить и сохранить отсрочку от армии во время обучения",
      category: "military",
      keywords: ["отсрочка", "армия", "военкомат", "призыв", "служба", "студенческая отсрочка", "освобождение", "не призывают", "учебная отсрочка", "академическая отсрочка", "временное освобождение", "призывная комиссия", "военная служба", "воинская обязанность"],
      tags: ["армия", "отсрочка", "призыв", "освобождение", "студенческая"]
    },
    {
      title: "Военкомат для общажников",
      url: "./pages/military/military-office/",
      description: "Взаимодействие с военкоматом во время учёбы и проживания в общежитии",
      category: "military",
      keywords: ["военкомат", "военком", "призывник", "документы", "справки", "учёт", "взаимодействие", "воинский учёт", "военная регистрация", "постановка на учёт", "снятие с учёта", "справка из военкомата", "повестка"],
      tags: ["армия", "документы", "военкомат", "учёт", "общежитие"]
    },

    // === СТУДЕНЧЕСКОЕ САМОУПРАВЛЕНИЕ ===
    {
      title: "Кто такой староста",
      url: "./pages/self-government/leader-requirements/",
      description: "Требования и личные качества старосты группы",
      category: "self-government",
      keywords: ["староста", "лидер", "группа", "руководитель", "ответственность", "требования", "качества", "старший группы", "представитель группы", "лидерство", "авторитет", "организаторские способности", "коммуникабельность"],
      tags: ["лидерство", "группа", "староста", "качества", "требования"]
    },
    {
      title: "Что делают старосты",
      url: "./pages/self-government/responsibilities/",
      description: "Обязанности, функции и задачи старосты группы",
      category: "self-government",
      keywords: ["староста", "обязанности", "функции", "журнал", "группа", "деканат", "ответственность", "задачи", "посещаемость", "успеваемость", "связь с деканатом", "организация мероприятий", "дисциплина", "расписание"],
      tags: ["лидерство", "обязанности", "функции", "группа", "деканат"]
    },
    {
      title: "Студенческое самоуправление",
      url: "./pages/self-government/",
      description: "Система студенческого самоуправления в университете",
      category: "self-government",
      keywords: ["самоуправление", "студсовет", "активность", "управление", "студенческий совет", "организация", "студенческая жизнь", "инициативы", "участие в управлении", "демократия", "представительство"],
      tags: ["управление", "активность", "студсовет", "организация", "участие"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - IT И ТЕХНОЛОГИИ ===
    {
      title: "ITимка",
      url: "./pages/organizations/it-tech/itimka/",
      description: "IT-сообщество студентов РГАУ-МСХА имени К.А. Тимирязева",
      category: "organizations",
      keywords: ["ITимка", "IT", "программирование", "технологии", "сообщество", "разработка", "хакатон", "айти", "информационные технологии", "coding", "кодинг", "веб-разработка", "мобильная разработка", "алгоритмы"],
      tags: ["IT", "технологии", "разработка", "программирование", "сообщество"]
    },
    {
      title: "Team Today",
      url: "./pages/organizations/it-tech/team-today/",
      description: "Студенческая команда разработчиков и IT-проектов",
      category: "organizations",
      keywords: ["Team Today", "команда", "разработка", "проекты", "технологии", "IT", "тимтудей", "айти команда", "стартап", "веб-проекты", "мобильные приложения", "цифровые решения"],
      tags: ["IT", "команда", "проекты", "разработка", "стартап"]
    },
    {
      title: "Кибертимка",
      url: "./pages/organizations/it-tech/cybertimka/",
      description: "Сообщество по кибербезопасности и информационной защите",
      category: "organizations",
      keywords: ["Кибертимка", "кибербезопасность", "безопасность", "хакинг", "защита информации", "киберзащита", "информационная безопасность", "этичный хакинг", "пентест", "CTF", "криптография"],
      tags: ["IT", "безопасность", "киберзащита", "хакинг", "защита"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - НАУКА И ОБРАЗОВАНИЕ ===
    {
      title: "Научные кружки",
      url: "./pages/organizations/science-education/research-clubs/",
      description: "Научные кружки и исследовательские группы университета",
      category: "organizations",
      keywords: ["наука", "исследования", "кружки", "научная деятельность", "проекты", "эксперименты", "научный кружок", "исследовательская работа", "НИР", "лаборатория", "научные исследования"],
      tags: ["наука", "исследования", "образование", "кружки", "НИР"]
    },
    {
      title: "Образовательные проекты",
      url: "./pages/organizations/science-education/educational-projects/",
      description: "Студенческие образовательные инициативы и проекты",
      category: "organizations",
      keywords: ["образование", "проекты", "обучение", "курсы", "мастер-классы", "семинары", "воркшопы", "тренинги", "лекции", "образовательные программы", "peer-to-peer обучение"],
      tags: ["образование", "проекты", "обучение", "курсы", "развитие"]
    },
    {
      title: "Студенческое научное общество",
      url: "./pages/organizations/science-education/scientific-society/",
      description: "Научное сообщество студентов университета",
      category: "organizations",
      keywords: ["научное общество", "исследования", "конференции", "публикации", "наука", "СНО", "научное студенческое общество", "академическая деятельность", "научная работа", "научные статьи"],
      tags: ["наука", "общество", "исследования", "конференции", "СНО"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - РАЗВЛЕЧЕНИЯ И ДОСУГ ===
    {
      title: "Развлекательные организации",
      url: "./pages/organizations/entertainment/",
      description: "Студенческие организации досуга и развлечений",
      category: "organizations",
      keywords: ["развлечения", "досуг", "отдых", "игры", "квизы", "вечеринки", "дискотеки", "караоке", "настольные игры", "киноклуб", "развлекательные мероприятия"],
      tags: ["досуг", "развлечения", "отдых", "игры", "мероприятия"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - СПОРТ И ЗДОРОВЬЕ ===
    {
      title: "Спортивные секции",
      url: "./pages/organizations/sports/",
      description: "Спортивные секции и команды университета",
      category: "organizations",
      keywords: ["спорт", "секции", "команды", "тренировки", "соревнования", "фитнес", "физкультура", "здоровье", "спортзал", "футбол", "баскетбол", "волейбол", "теннис", "лёгкая атлетика"],
      tags: ["спорт", "здоровье", "секции", "команды", "тренировки"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - ТВОРЧЕСТВО И КУЛЬТУРА ===
    {
      title: "Творческие коллективы",
      url: "./pages/organizations/creative/",
      description: "Творческие коллективы и культурные организации",
      category: "organizations",
      keywords: ["творчество", "культура", "искусство", "танцы", "пение", "театр", "музыка", "хор", "ансамбль", "творческий коллектив", "культурные мероприятия", "концерты", "выступления"],
      tags: ["творчество", "культура", "искусство", "коллективы", "концерты"]
    },

    // === СТУДЕНЧЕСКИЕ ОРГАНИЗАЦИИ - СОЦИАЛЬНЫЕ ПРОЕКТЫ ===
    {
      title: "Волонтёрские организации",
      url: "./pages/organizations/volunteer/",
      description: "Волонтёрские и социальные проекты студентов",
      category: "organizations",
      keywords: ["волонтёрство", "добровольчество", "социальные проекты", "благотворительность", "помощь", "волонтёры", "социальная работа", "общественная деятельность", "добрые дела", "социальная ответственность"],
      tags: ["волонтёрство", "социальные", "помощь", "благотворительность", "добровольчество"]
    },

    // === ПОДДЕРЖКА И FAQ ===
    {
      title: "Часто задаваемые вопросы",
      url: "./pages/support/faq/",
      description: "Ответы на популярные вопросы студентов и абитуриентов",
      category: "support",
      keywords: ["FAQ", "вопросы", "ответы", "помощь", "поддержка", "справка", "частые вопросы", "что делать если", "как", "где", "когда", "проблемы", "решения", "инструкция"],
      tags: ["поддержка", "помощь", "FAQ", "вопросы", "ответы"]
    },
    {
      title: "Контакты авторов",
      url: "./pages/support/contacts/",
      description: "Контактная информация авторов гайда и способы связи",
      category: "support",
      keywords: ["контакты", "авторы", "связь", "поддержка", "помощь", "обратная связь", "телефон", "email", "социальные сети", "мессенджеры", "как связаться", "написать авторам"],
      tags: ["контакты", "связь", "авторы", "обратная связь", "поддержка"]
    },
    {
      title: "Для кого этот гайд",
      url: "./pages/support/target-audience/",
      description: "Целевая аудитория и назначение справочника РГАУ-МСХА",
      category: "support",
      keywords: ["аудитория", "назначение", "для кого", "студенты", "абитуриенты", "цель", "целевая аудитория", "кому подходит", "кому поможет", "применение", "использование гайда"],
      tags: ["информация", "аудитория", "назначение", "студенты", "абитуриенты"]
    },
    {
      title: "Дополнительные вопросы",
      url: "./pages/support/additional-questions/",
      description: "Дополнительные вопросы и расширенная информация",
      category: "support",
      keywords: ["дополнительные вопросы", "расширенная информация", "подробности", "детали", "углублённые вопросы", "специфические ситуации", "особые случаи", "нестандартные вопросы"],
      tags: ["поддержка", "вопросы", "дополнительно", "детали", "подробности"]
    }  ],

  // Нормализация URL для корректных ссылок
  normalizeUrl(url) {
    // Если URL начинается с ./, заменяем на абсолютный путь
    if (url.startsWith('./')) {
      return '/website/' + url.substring(2);
    }
    // Если URL уже абсолютный, возвращаем как есть
    if (url.startsWith('/')) {
      return url;
    }
    // В остальных случаях добавляем префикс
    return '/website/' + url;
  },

  // Инициализация
  init() {
    console.log('🔍 DropdownSearch: начинаем инициализацию...');
    this.findElements();
    this.bindEvents();
    console.log('✅ DropdownSearch: инициализация завершена');
  },

  // Поиск элементов в DOM
  findElements() {
    this.elements.input = document.querySelector('.header__search-input');
    this.elements.button = document.querySelector('.header__search-btn');
    this.elements.dropdown = document.querySelector('#searchDropdown');
    
    console.log('🎯 Найдены элементы:', {
      input: !!this.elements.input,
      button: !!this.elements.button,
      dropdown: !!this.elements.dropdown
    });
  },

  // Привязка событий
  bindEvents() {
    if (!this.elements.input) return;

    // Поиск при вводе текста
    this.elements.input.addEventListener('input', (e) => {
      this.performSearch(e.target.value);
    });

    // Поиск при нажатии кнопки
    if (this.elements.button) {
      this.elements.button.addEventListener('click', () => {
        this.performSearch(this.elements.input.value);
      });
    }

    // Скрытие dropdown при клике вне поиска
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.header__search')) {
        this.hideDropdown();
      }
    });

    // Фокус на поле поиска при нажатии Ctrl+K
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        this.elements.input.focus();
      }
    });
  },
  // Выполнение поиска
  performSearch(query) {
    if (!this.elements.dropdown) return;
    
    query = query.trim();
    
    if (query.length < 2) {
      this.hideDropdown();
      return;
    }

    console.log('🔍 Выполняем поиск для:', query);

    // Улучшенная фильтрация результатов
    const results = this.searchData.filter(item => {
      return this.isMatch(item, query);
    }).sort((a, b) => {
      // Сортируем по релевантности
      return this.calculateRelevance(b, query) - this.calculateRelevance(a, query);
    });

    console.log('📊 Найдено результатов:', results.length);
    this.displayResults(results, query);
  },

  // Проверка соответствия элемента поисковому запросу
  isMatch(item, query) {
    const queryLower = query.toLowerCase();
    
    // Поиск в заголовке (высокий приоритет)
    if (item.title.toLowerCase().includes(queryLower)) {
      return true;
    }
    
    // Поиск в описании
    if (item.description.toLowerCase().includes(queryLower)) {
      return true;
    }
    
    // Поиск в ключевых словах
    if (item.keywords && item.keywords.some(keyword => 
      keyword.toLowerCase().includes(queryLower)
    )) {
      return true;
    }
    
    // Поиск в тегах
    if (item.tags && item.tags.some(tag => 
      tag.toLowerCase().includes(queryLower)
    )) {
      return true;
    }
    
    return false;
  },

  // Вычисление релевантности результата
  calculateRelevance(item, query) {
    const queryLower = query.toLowerCase();
    let score = 0;
    
    // Точное совпадение в заголовке - максимальный балл
    if (item.title.toLowerCase() === queryLower) {
      score += 100;
    } else if (item.title.toLowerCase().includes(queryLower)) {
      score += 50;
    }
    
    // Совпадение в описании
    if (item.description.toLowerCase().includes(queryLower)) {
      score += 20;
    }
    
    // Совпадение в ключевых словах
    if (item.keywords) {
      item.keywords.forEach(keyword => {
        if (keyword.toLowerCase() === queryLower) {
          score += 30;
        } else if (keyword.toLowerCase().includes(queryLower)) {
          score += 15;
        }
      });
    }
    
    // Совпадение в тегах
    if (item.tags) {
      item.tags.forEach(tag => {
        if (tag.toLowerCase() === queryLower) {
          score += 25;
        } else if (tag.toLowerCase().includes(queryLower)) {
          score += 10;
        }
      });
    }
    
    return score;
  },

  // Отображение результатов
  displayResults(results, query) {
    if (!this.elements.dropdown) return;

    if (results.length === 0) {
      this.elements.dropdown.innerHTML = `
        <div class="search__no-results">
          <h3>Ничего не найдено</h3>
          <p>Попробуйте изменить поисковый запрос.</p>
        </div>
      `;    } else {
      const html = results.map(result => `
        <a href="${this.normalizeUrl(result.url)}" class="search__result">
          <div class="search__result-title">${this.highlightText(result.title, query)}</div>
          <div class="search__result-description">${this.highlightText(result.description, query)}</div>
        </a>
      `).join('');

      this.elements.dropdown.innerHTML = html;
    }

    this.showDropdown();
    console.log(`✅ Отображено результатов: ${results.length}`);
  },

  // Подсветка текста
  highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<span class="search__highlight">$1</span>');
  },

  // Экранирование спецсимволов регулярных выражений
  escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  },

  // Показать dropdown
  showDropdown() {
    if (this.elements.dropdown) {
      this.elements.dropdown.classList.add('active');
    }
  },

  // Скрыть dropdown
  hideDropdown() {
    if (this.elements.dropdown) {
      this.elements.dropdown.classList.remove('active');
    }
  }
};

// Глобальный доступ
window.DropdownSearch = DropdownSearch;

// Инициализация при загрузке DOM
document.addEventListener('DOMContentLoaded', () => {
  console.log('🚀 DOM загружен, ждём загрузки header...');
  
  // Задержка для загрузки header компонента
  setTimeout(() => {
    DropdownSearch.init();
  }, 500);
});
